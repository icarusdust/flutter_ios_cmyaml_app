workflows:
  ios-workflow:
    name: iOS Workflow
    # instance_type: mac_mini
    max_build_duration: 120
    environment:
      vars:
        XCODE_WORKSPACE: "Runner.xcworkspace"
        XCODE_SCHEME: "Runner"                
        # https://docs.codemagic.io/code-signing-yaml/signing-ios/
        APP_STORE_CONNECT_ISSUER_ID: Encrypted(Z0FBQUFBQmc3Q0UxYnN0YS1PYjdkblFfemppQkdfR2RTV1FiclpHRVVsdUcwb1R6dkFyRnRWU1RLbFc4Z1BIUURwQUxfZHBiVGpkalAyUzI3OFpqWjdZbi1HUGtzLVZGWlh3dk5tRG1tQ1VMeTNwSXFKT0ZWOVY2amNvdDRLTEQ0Nmh2UU9NM19xbEI=) # <-- Put your encrypted App Store Connect Issuer Id here 
        APP_STORE_CONNECT_KEY_IDENTIFIER: Encrypted(Z0FBQUFBQmc3Q0QyNG1Jd1c4TFl5ZVVyNmFoZHVVbFFKZzVmNm1PTjlYZE1ab3dIYkx1MWJzcnkzRlVSalhwVXNpSHZUdW9jQ3o2TkhXdW5WUVZNd1V2bzZtOWZzZmpmdWc9PQ==) # <-- Put your encrypted App Store Connect Key Identifier here 
        APP_STORE_CONNECT_PRIVATE_KEY: Encrypted(Z0FBQUFBQmc3Q0VicVpVMDV1QWt0M1YxLTJCUXRublN4bC1MTlhoUnoxZnZ0ODkwUk0wNkJtVDB2UGgxWEtHRGU0ODRYeDBuTHkyVVNQeGpqVUxpekRZelZUamhiYkNrTEFsM2Q3SnJDMEJQNWdDTk5VVXgyaUROVXBnMWVPY1MxUk1GTUNZTTNCRERLTlFtT29Lb0UtQ0FEOERIWU5fZWdrTm5JS1N6RnlMenRzdE00Z2w3aWtNdkU5Qnd0SmlNWlp5ZGlkVG1MNXFObGlSNEFHMnVIRU9KUjY1d0tyYmtTdW9rSjNBLUJoX0tzWVgwdmZCYkZCN2g1NzBFemtfS0ZDeE9vMlB2ZU95MlItWXRoQzdEOTdFcTU3ZXhFb1pacERiNUVSOWhDN2QwMkhHOFFJSVNiTmFXUm5hR1RldzNsT0RUOXVLZFVRcTEzUFpsSW5UcVB4dnhIMlotLTZGRFVyMTI3ZHRabVFhZGJoQzJRLXRrNmFfSUI2RDBTV1ZHcHk5bURmblhNZHpOUnVTVnhBY1JsNnRGb3lXdUdjU1Y5Z3F2VFBBcGtxNjhxRUFfYmVnVEFYWT0=) # <-- Put your encrypted App Store Connect Private Key here 
        CERTIFICATE_PRIVATE_KEY: Encrypted(Z0FBQUFBQmc3Q0ZnUHo0c0N1MFU5aU0xNXR4UG13TGRPZlA2WkJ5R3NZVGZFNTNNSmFnRnNORm1MUDNYRXhxaGgtSnFrSVFIb2d0S0hyOGNmOElmbnZONjhuYkoyLXYtSmQxcEdpcFpyd1FkUDZCakdNVWlmVUlxbEotblpZWW0xLWNrcWo1OUdSWFJYNWswSmFWZjh4eUl0ZzlzVmpNZGhCbDdST2p5d3ludGl3YU1PczlFa0lPU2djWmlDRTh4WW5INF9wenhGci1NN3FMOG91R3UxLUM3QU40Zzd6c1JwNkJ3UkJhVzVhQUhJNy1RTFpsS3M4YWYzUmxkRlBGaHVWdzJsQWxWUFZ5bENieUp2elpRbXEwX091YVExejhON0FTMmJudlAzVVNHRDJzSmRQaXVkbTc5NHFhNEYzX2xMM1lGbElnMV90cXJaU0RrLTJCMVhXMEpWSmFTMDh3SHh5ckltdGd1bWlza3JtTjVZVDI3YkVMTWpGNmxza1FlZkk1WllUZzdBVmQ4d042XzdoMnJlcE1wc3IwUHdnWS10clpoTjE5Nk1ERzZPaUczdTR2YTg2QnNxTWJzaDZYaUlfSml5Rzc0bVlmUm5NRDZXclEyWjFHaUh5b25zZV9GYXA4T0lSTkZaYTVUaExzTHoxUkFqc0duWkh3Y1cwRlBNMC1YYUZYeUlfc0VTNE1ZUkdLZ1dVWVJOV2ZfMExaN0l3alRoejFjQUNBY1phakNqVnhYS3YyTG9RRDJnOExZc205cDFfRVptUU1KX2k2a3FLZXBKNE1QdWxuUllRcXR4UXpMTUJDeGxnV3JEV3JCeDUwam95N0h2OVd3U0NkUzEybm11M055Y2hGd3JyeHJhVWFaQ3otdVoxT1liME9ITVpka3Y0Y3NsdWVmcDJZbTItTUtWNmVHRXdtR01pSjdsdWYwd3dyRGhGM1ZEV3lrUFVXZUVtYkVCeE5VXzEwUFlHZ0Q2WE1Cb0hoQ0lLYVlQTGpLbzVMajhEYlhmRTdVd0hZR0d2c2NybUFDQmJQVVVqeTBIZEVITFFSbWQwRUVqN19lZDZYZXdYVVdHM0FLZTJSUzJxNWhLSzVObmdzbFVCUWtHMlZYZEtZQ2tkOFFvUVdUQXpZaVEwcFE3TWRFWHFlZXZWc09ZTWlIVmkyUkw1cV9Zd0lIX3pjallJdmFFOTFLbnZ0Q2dKTUhEQ3V0c3d4RUtpWHpRdHZXNWJRQmZtN1FQdk10RzEzeGFuM2tTa2Z0c1hzalFyeEMwb2F6ck03YW1GSnFRWlZFRWRfSVJUWDlKaGMta0VYeVVteGJrR2t0VF93QVBTMzBvWnVjbUxsWWtsZ05jOVNiNm5QODZQay1ZdjhrMEpVbU5vc1BUSlpTWVdpVW5wbXJXNjdtbFVXNGZFRFIzNzAyT2pob3hBZzdOUWd3X2daSmJFbjJ5MjRBX0x3emRWeWVJQzlPRzJfZUdBbGszLXBiNVlsc3pGVmRBa0F3cGdjckpjVGZGdERWLVVjZXJzQ2Q3Y2ExODE4S1NpMEFKYXRRTE9KU0tJV3A0blp2NExHeHlIRjVoTE03ZWFUaGVKaEtjY1FKSnZUMGxCbjllbUFmRmJZSGlZSmtWbDVnTDVPWm9kQmpzVjN3eS1hclN6QUJLaEdqZWo0SXAwakVYSTF2dGhMRURJUzRFZ0tnMXRuZG5zV1FKMU9KV0l2OFNabnBBbjcyV0hiLXEzb3llM01PVjBwQXU1a2J0SGVSbnNtcEQ2c3NLQ0tuZ0VwLUNyZzNRQkFsOU9EM3Y5X1d4NFZOWXZrYjFkQnJkRFFHM2dsS1VIdUpZYkxKRnlpLXhhU2JyVUcyeVpMS3Ewb0dKNzdnM3g1OHlDVGpjTFIxSmJPaGFlQk80R1F0cUxaZ3ItNzlxVUU4MWxuT29Nd1N3NVBiVDBIbS1mYmpfX0c0dXNoTXkwcFJXaFpPVVBhYUtqaG8yR1IwNHRXU3JXcTk4VDNxd1hDVWVWM2VRQVctcTB2Z2N2RWxaNy1BZmdadjJqZHF5NVdYaUpkcElScm51Y3MyVnNIbDloRDEzM3R2cENGRlh6UUZpQ0xwdGVpWk8xOE5FM0pZN2twRk5nUW8xZ3RsaFNrakdMR2pVTnJ0OXM5clNDY1NWUW1qLXAtNEp2MDY4YktqZ2wwVngxWndpUkJweXFPaV9rRW1FU2RISnRrZzVPNVlnVzEzUGpJYXRMbFlyZDZINzdYcmxGZlN3cGFCWnB6ZkVTaTBiYWFOaVhhaFRXMHc1X29sZk5YS0g5Um5nYzFTSnZycTZOamJLQjNlM1NfUE9ickM4WW9JclVRV1piaGRNalFQeEFsR29tVE10OTdLcWhoMXZjdWs4QzFUSTZiY3lNaEM4eTBmRVk0Tm1OZzZtLVhkM0VmcjkxQ3lGOVBzOWNiS2lTZlJuc2ptOEJKQnpBLUFPZG5JQ196dmdKZEU2WWVraTk0WkpJU0ZZRlpMeTBVRzJjczlwRjN6ZzJMbTY5NW1KUlhuX3VKSWhUSlN4S3k5RTZvTldwenNpMkVoVVYtZlVnbmw1WHJsdWVfMUplVldmMG5Pdl9Oc1ZmbGtMaWgyaERCYUxGbnVreWZIY05GUkFvdnAzZHVsOXV4Yy1weTVLeEJmbktFc3lnQjRwWmRNc2JKbTBsSzV3djZEOEdlakRNQndENkt4VFZ3Rk9nZXMtVXFuNDJfalg1aU45XzQzUXhFREVxYzh6YzV4c1BVdk5NTFFnbE13QlExT1lYWDdxaDcta2ZuQWpkdEotQmtvcVJRVXNnLTBxM01yVEpldFNfRXUzTWxjNWdFQnVnNFFOenJLdVpmU2xKekZOMUh5OHNGaWdyajVaZ29sOUdtbFZ3NnZKUVhNemIxaksxNzlXMVhDeWh4UWoxRVpoMnNyYnUtSmlzV0ZPN0w5akZLeUp3RUZMMGM3WktLOGZsRk10RkI1UHRDbEtfR2NOck5KVlFLZlp1bko4Y3F5cV9KbGh1UW9BRm93TW5FYU9LZ1pKdU5zLVlxa1FYQ0xTVlFWNVpZa0hMd3NzX3NKU2tlbW5yN2gyWERz) # <-- Put your encrypted Certificate Private Key here 
    #    APPLE_ID: Encrypted(...) # <-- Put your encrypted Apple Id email address here
       # APP_SPECIFIC_PASSWORD: Encrypted(...) # <-- Put your encrypted App Specific password here. See here for more information - https://support.apple.com/en-us/HT204397
        BUNDLE_ID: "com.icarus.app" # <-- Put your bundle id here
       # APP_STORE_ID: 1576168168 # <-- Use the TestFlight Apple id number (An automatically generated ID assigned to your app) found under General > App Information > Apple ID. 
      flutter: stable
      xcode: latest
      cocoapods: default
    scripts:
      - name: Set up keychain to be used for codesigning using Codemagic CLI 'keychain' command
         script: |
           keychain initialize
      - name: Fetch signing files
         script: |
           app-store-connect fetch-signing-files $BUNDLE_ID --type IOS_APP_STORE --create
      - name: Use system default keychain
         script: |
           keychain add-certificates
      - name: Set up code signing settings on Xcode project
         script: |
           xcode-project use-profiles
      - name: Get Flutter packages
         script: |
           cd . && flutter packages pub get
#       - name: Flutter analyze
#         script: |
#           cd . && flutter analyze
#       - name: Flutter unit tests
#         script: |
#           cd . && flutter test
#         ignore_failure: true          
      - name: Install pods
         script: |
           find . -name "Podfile" -execdir pod install \;
      - name: Flutter build ipa and automatic versioning
         script: |
           flutter build ipa --release --build-name=1.0.0 --build-number=$(($(app-store-connect get-latest-testflight-build-number "$APP_STORE_ID") + 1)) --export-options-plist=/Users/builder/export_options.plist
    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - flutter_drive.log
    publishing:
      # See the following link for details about email publishing - https://docs.codemagic.io/publishing-yaml/distribution/#email
      email:
        recipients:
          - nihal@nevercode.io
        notify:
          success: true     # To receive a notification when a build succeeds
          failure: false    # To not receive a notification when a build fails