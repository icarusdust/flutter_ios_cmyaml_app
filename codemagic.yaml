
workflows:
  ios-workflow:
    name: iOS Workflow
    # instance_type: mac_mini
    max_build_duration: 120
    environment:
      vars:
        XCODE_WORKSPACE: "Runner.xcworkspace"
        XCODE_SCHEME: "Runner"                
        # https://docs.codemagic.io/code-signing-yaml/signing-ios/
        APP_STORE_CONNECT_ISSUER_ID: Encrypted(Z0FBQUFBQmc3QS0zTEUxUGZnWDRxMGtseTBLdGtkcFB0V0RlTjJ0TEFYQ0VZcDNhYUpNX051ZWszMWdnbmEyaHhoQlVIU0g5Rk0wOEtfYXBZUU1Gb3FkSWJGYllOM29iRFloYS1UeEhYbzM2aGRFOWNkQmF5SERwRFNoU1dkdE1NaGZVYjVxRXhOMXI=) # <-- Put your encrypted App Store Connect Issuer Id here 
        APP_STORE_CONNECT_KEY_IDENTIFIER: Encrypted(Z0FBQUFBQmc3QS1hXzRQY0pGZEc4MGYtUTZEdGhSYjVIdUswdUZsdGROV1lmMW1RV2Q4RHpxMmpOT1hfWkNVaGFtNFdXNkFPR3diMWREY1dnLXpySURYbnJMbm5VbV92S0E9PQ==) # <-- Put your encrypted App Store Connect Key Identifier here 
        APP_STORE_CONNECT_PRIVATE_KEY: Encrypted(Z0FBQUFBQmc3QV90Zl9FdlVOS1ByYmVuOWRzekJwQkJVVURKSVdDV3hIUjVueTRUZGV1Y0doVVJCd2swN2hYTWNXU0VTclcxX1NibHZYU2F6V0FKZE1FNHlROURBVDB4ZmpiN2ljVHZVNGo1REM4czJrSDEzMHU5SFIyQ2dtcHBTMTFHcHBfQVRqUG9EZ1h6d21ldlk4Q0JRbUo2SHBhRUt5REJZS2RPd19uQ2psaW54QnNwTkQ0LVV1aldMVENyV0ZaZnJLR01nNGlNVVk4WkJBRHJKT1JBdjlPcmVUSEhZSjg5RTRkSGUzNTNDUmZXNzhSMFh4YWp1ZnVSTm9PWXJBQU8tSkhzTXVscWFfZkd2SnFya3VMOEIySWhoN3F3V2d6MWFEWmYybzdvdkI1SFlqMDhDQTN3UzNCeWVVODg4eGo2NnV2QklYbWdvbVZYR3R3LXU4d1NJV2xrVHlpUzVRcDBpTGl4QVk0Z3JfN0hVZ0M5RTNwdmlMTXVaYllieEpPcDZiZGVCeXFObjZPUFNVU3dKdDA0ZUItNFRwTmhUYVdzcDc3LVVUUWpRcTNuSXZndm5TOD0=) # <-- Put your encrypted App Store Connect Private Key here 
        CERTIFICATE_PRIVATE_KEY: Encrypted(Z0FBQUFBQmc3QkZIZ095SndOLXJSTC1MVmhPQlNWcVZqYVNnRkFDWEpPQnBGQzVxUmcxMGxtSENnWG1zb0h6MFNYZTgwYmVFc3RPRkJZa1k0SFY3QkZjaTN0SDl4VFlnS05SZk1kQ2IxTm5YV2xGS201NzE5LUpKUGRyYTF5bDl6Mm5WQm5EVTAxZ1B3SDRFSURKMEM4QzVLRDZaWFRmLUZLRlhJelU2bXAwQUVHeFZjY1Q1dGJHRXNXTUs0cVVzUDhtR2VpeXk4QXlDUEgxcDVNV1dLTk5Wb1FDUmdRNlljZ2Jwc08yLThBSVlLcnRwblQtcnVTT0pmSnktM0N6ZGlGNE9ZV1RpeTZPYnRNMFoxbV9MTzFUNGVISEFzX1JyWjJiMlNid1pKNFctY0U3QVIxMHlJX1FkSzhFQUZod3MweXVnTVhkUHlzRGhWNDNwbGc5LTN1WjVlRDNITHh2MjRhNXhVSERjVXhaamJoak9TejM2bWV0RmpLaU1nWjJ2MFRrWkRpaVA3MEx5cXNEaWI4YzQtcnVFZ2tDTGlEbmlLSEFueFhmNnVSMl94NHVNem9wdXJ1MnBCbVM0SjdCM0VMaExiRnhrVFFCWl9YMndhdlNpQ045MkR3YUE0VWtqcWJsZUowS1ppVWo3UmR3WG94VXZZN1JuaHhpbnRQQVBJeXcxdzFoaXJ1WnJSZzViTk8tdHJVYUV4Q1VtXzBuR2tRbkpBZ0JodXE2WVhyYUpxLUM1RUVZaV9Ha0VoQXNtSmJWNHZXX0NWREI3am1RdTZYZUh0RWRFeHlvQ0lSTDFLVFNlOTFHU3c4UzQ3a242TUFIbzdjS0dDa1RnM2Z1Y01xMVdRR3lTMWc5T09lVFJqWldHYy1taDNwNFV0WFg5cnVLakdwQm5EdnJFekxvLWdWVlVweE5BRkZQeUpyM2NhMGlTZm15alFielVvZUVpWnZvRzM0bW1kejYtenh6N1NHbkhMU0J0bFZmQUo1NklOVEtzTHgzOUpIRmVSeTFlVzE1eDh5aUliR3Y4b0hoLU9SY1p1OVRuZFMtSExRNG9kQW5xbnRYZ1ZCRHBBY0h2NlRYek1xSTU2ZTR3aGZNNS1QZmFGcFNsZFJ4VnV2eVpsSTJKeDNVTWZHWF9oR3hXM19EdE1QczZ3NEwxZmFvMF9ybXdnb1Z3dlk0X3M3M0h5NlJCZW50QzU2dXRzZm1Bdlc3OGpjZjE3X0ltZkxJVW0tYjVPbTl0VHpXUGNOcWstTnpGTWppb1ozR3p3N0FkRzN3ZVMzV1lWSzY5RV9kZy1zcUVRa3dYcmZ5RWhSV3RpUDVnYThNbHJLRnVfVEtDVHdjZmVhanpVeDRHX0dOS3BIR2EtZTRoX1ZkTExKYm5ZcHFpUzhLaGdwLXY1S0R3cTRGR0owU2FQV0h0WWpkM2lqZmpHNmF3c3lRYUhfZXRSV1Fsa3BqSU5sZVQxdHIzcjQ3b2VwdjZtZjBBVFFKaHNqX2E3NmtEam5ia3J6VzlaTEdWUzI5Ml83QlJCQU9uZGNKZVpublBWY2JncHZEd0tZMWRnRnBZTVpTRHZpVklOc3RKTW1jWkkxRGJ6Ujh3cHFkNlMwQjZoSFROTFpPUFE4MTgxUV9kMnZLSlpHUFBvYVZjemhETmlnMGFPYnBLQ1pzTEl4YnVIa2JuWHhxcTBTTjVvRmZ0LTJyWjkzLU5VM2JFSTcyWEs4SzVYV2lLZmpSdUwyTEN5UVNMbmJlZzVNYWN5RG12Njh0bFFsVFUwQndsWlR2bmtybVRiS3dWZVZnNV9mMC0zUnpDdWV0S1JjMUJ4T1pwQWFhZkV0LXcyX2hmRkNZZV9pV21MVTZYVHdQMU1ZQXAwUEFpZnNWc1htT2hDRjdmelRTcWtMMTdKa2hZU0VMMUJzTksyZWxtdVlCckJWN2xGOGVOU0NGSE5PZTB6SzF0bVFYTFVmbm4yc1B6V0k4bV9YR0VDcFVrdW1ZTHd2ZzEtVnJSV003NXQwZElscElKaXkzN3FNSnZqS2tzZzBLVVRwRDRObnEzNThzLXdFOXZHOG5nRlZrWTJyWW5RLVJ2UGJITUJ2eS1xMGVaSGpQS25IMkJpQVo2T1g2NjhIVF90Um1FbjhrQkY5TDlfU3F6bDlPV1p2a3huQzNFcURmWXNLc283d01MRjNyUXZQUXRYVWlPTUE3eDNjV2hWRW1famhzSC1HWHJ5R3o1VzN2Qzh6VllDRXpfMU5HX0huZlU3b2MzUnhiYmtyNnhRQ01hcUpNZUZ1d2dMbGhKVkxudnNseW85UXFJbFRvdEpuQlpTelRUQ0puSG43MUp0eXluWVhqMkVLMUg0ajVwaHJIemVVNTB4Y09SRk1YQ3lmdTJ4LUFmR2dQdTFwVnpfaWtrQ3RyWEE0NlNIcWNlQW5uSVZmeXBCcXFmR08zcXR5bXVLZTRtSEVaZXhMT2FORGgtZFNFeGFIZ0QzLXdsN0VFanM5RWNMaWIzdGtGSHBZVEZ4VHpkcm50VGlXVDdQSXhQd0hIMHdFUGF5eWlNVWRveTlNVlBaUnN6RkhFQlNXSmJPS1VKcm94TWtkVTRnZEJSQWpCc3dmYXo0dmdLQVRzRnI4MGRBQ1RzVWdLZGhVbmloRjNaaHg5RHViemIwZ1k0WmdYTG9fZC1Od1duZmVlT0xuQnVtcENvX0xwYWp1dXNmcEN3VzI0cjRneU9kekRwQW9hb2F6UmtSb3lWaTBySzR5alhHX0FWeExMd2hpOFNuWEsxaHcwTUVXaXpPbEtBTUc1WTZXLVozWXBpX2ZJMmRwbTF3UE5wR01SSDItUUlaSU1QeXotWWtfaWNidkFUSTY4VTZCcjRrb0Y2YTBndmNCRjZyV1ZLWGZONXpnNUFWOXVyTWJ4QXFQdFVQUDVEQUt5bXNxa2wwRkZvNVFuUlZrcVlYaXdiUTdkNGFkdzdHRFRld0l1cmJ2UnVySGw3MVROcjhtdmJxQXFBZE9xWEVuRzQtZzE2dVg1U0JiNnQ4RTBiSkJRVkM1NGVVU21mc3NZbDByWlFvZVJ1d2poUDNJNnZHUTd1R1pXMkx0S2x3MW1R) # <-- Put your encrypted Certificate Private Key here 
    #    APPLE_ID: Encrypted(...) # <-- Put your encrypted Apple Id email address here
       # APP_SPECIFIC_PASSWORD: Encrypted(...) # <-- Put your encrypted App Specific password here. See here for more information - https://support.apple.com/en-us/HT204397
        BUNDLE_ID: "com.icarus.app" # <-- Put your bundle id here
       # APP_STORE_ID: 1576168168 # <-- Use the TestFlight Apple id number (An automatically generated ID assigned to your app) found under General > App Information > Apple ID. 
      flutter: stable
      xcode: latest
      cocoapods: default
    scripts:
      - name: Set up keychain to be used for codesigning using Codemagic CLI 'keychain' command
        script: |
          keychain initialize
      - name: Fetch signing files
        script: |
          app-store-connect fetch-signing-files $BUNDLE_ID --type IOS_APP_STORE --create
      - name: Use system default keychain
        script: |
          keychain add-certificates
      - name: Set up code signing settings on Xcode project
        script: |
          xcode-project use-profiles
      - name: Get Flutter packages
        script: |
          cd . && flutter packages pub get
#       - name: Flutter analyze
#         script: |
#           cd . && flutter analyze
#       - name: Flutter unit tests
#         script: |
#           cd . && flutter test
#         ignore_failure: true          
      - name: Install pods
        script: |
          find . -name "Podfile" -execdir pod install \;
      - name: Flutter build ipa and automatic versioning
        script: |
          flutter build ipa --release \
          --build-name=1.0.0 \
          --build-number=$(($(app-store-connect get-latest-testflight-build-number "$APP_STORE_ID") + 1)) \
          --export-options-plist=/Users/builder/export_options.plist
    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - flutter_drive.log
    publishing:
      # See the following link for details about email publishing - https://docs.codemagic.io/publishing-yaml/distribution/#email
      email:
        recipients:
          - nihal@nevercode.io
        notify:
          success: true     # To receive a notification when a build succeeds
          failure: false    # To not receive a notification when a build fails